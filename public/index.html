<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Open Combat</title>
  <style>
  
	.field{
	position:relative;
	width:640px;
	height:480px;
	
	background: green;
	
	text-align:center;
	}
  
	.card{
	display: inline-block;
	width: 58px;
	height: 89px;
	
	border-radius: 10%;
	border: solid 1px black;

	background: white;
	text-align:center;
	line-height: 89px;
	
	font-size:50px;
	
	margin:0 5px;
	}
	.rotate90{
	transform:rotate(90deg);
	}
	
	#hand{
	position:absolute;
	top:330px;
	height:100px;
	width:640px;
	display:flex;
	justify-content: center;
	align-items:center;
	}
	
	#oppositehand{
	position:absolute;
	top:50px;
	height:100px;
	width:640px;
	display:flex;
	justify-content: center;
	align-items:center;
	flex-direction:row-reverse;
	}
	
	.select{
	cursor :pointer;
	}
	.transparent{
	opacity:0.1;
	}
	
	#battle{
	position:absolute;
	top:230px;
	left:320px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	}

	#oppositebattle{
	position:absolute;
	top:160px;
	left:260px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	}
	#combo{
	position:absolute;
	top:245px;
	left:400px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	}
	#oppositecombo{
	position:absolute;
	top:145px;
	left:180px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	}
	
	
	
	#deck{
	position:absolute;
	top:360px;
	left:50px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	color:blue;
	}
	#oppositedeck{
	position:absolute;
	top:20px;
	left:530px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	color:blue;
	}
	
	#discard{
	position:absolute;
	top:360px;
	left:530px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	}
	#oppositediscard{
	position:absolute;
	top:20px;
	left:50px;
	height:100px;
	display:flex;
	justify-content: center;
	align-items:center;
	}
	
	#discardlist{
	position:absolute;
	top:140px;
	height:200px;
	left:50px;
	width:540px;

	background:rgba(128,128,128,0.8);

/*	display:flex;*/
	display:none;
	flex-wrap:wrap;
	}
	
	#battleeffect{
	position:absolute;
	width:640px;
	height:480px;
	display:none;
	z-index:256;
	
	background:rgba(0,0,0,0);

	}
	#battlemessage_top{
		position:absolute;
		width:640px;
		height:160px;
		left:0;
		top:0;
		text-align:center;
		font-size:50px;
		line-height: 160px;
		background:rgba(192,192,192,0.5);
	}
	#battlemessage_middle{
		position:absolute;
		width:640px;
		height:160px;
		left:0;
		top:160px;
		text-align:center;
		font-size:50px;
		line-height: 160px;
		background:rgba(192,192,192,0.5);
	}
	#battlemessage_bottom{
		position:absolute;
		width:640px;
		height:160px;
		left:0;
		top:320px;
		text-align:center;
		font-size:50px;
		line-height: 160px;
		background:rgba(192,192,192,0.5);
	}
	

  </style>
  <script>



const GMSTATUS = { BattleChoice:1 ,BattleWait:2,DamageChoice:3,DamageWait:4, BattleEffect:5, GameEnd:6 };

  class GameMaster
  {
	constructor()
	{
//		this.GameServer = new GameServer();

		const r = JSON.parse(this.GameServer.p1result);
		this.player = r.player;
		this.opposite = r.opposite;

		this.status = GMSTATUS.Choice;

		this.message_top = "";
		this.message_middle = "";
		this.message_bottom = "";
	}
	  
	Choice(index){
		this.status = this.player.damage > 0 ? GMSTATUS.Choice : GMSTATUS.BattleEffect;

		this.GameServer.Choice(index);
		const r = JSON.parse(this.GameServer.p1result);
		this.player = r.player;
		this.opposite = r.opposite;

		this.message_top = this.message_middle = this.message_bottom = "";
		if (this.opposite.damage > 0)
		{
			this.message_top = "Damage " + this.opposite.damage;
		}
		else if (this.player.damage > 0)
		{
			this.message_bottom = "Damage " + this.player.damage;
		}
		else
		{
			this.message_middle = "Draw";
		}
		if (r.status == GSSTATUS.GameEnd)
		{
			this.status = GMSTATUS.GameEnd;
			if (r.jugde > 0){
				this.message_middle = "Game Win";
			}
			else if (r.jugde < 0){
				this.message_middle = "Game Lose";
			}
			else{
				this.message_middle = "Game Draw";
			}

		}
	}

	BattleEffect()
	{
		if (this.opposite.damage > 0)
		{
			this.GameServer.Choice(0);
			const r = JSON.parse(this.GameServer.p1result);
			this.player = r.player;
			this.opposite = r.opposite;
		}
		else
		{
			this.player.hand.push(...this.player.draw);
			this.player.draw.length = 0;
			this.opposite.hand.push(...this.opposite.draw);
			this.opposite.draw.length = 0;


			if (this.player.combo) {
				this.player.discard.push(this.player.combo);
				this.player.combo = null;
			}
			if (this.opposite.combo) {
				this.opposite.discard.push(this.opposite.combo);
				this.opposite.combo = null;
			}
			this.player.discard.push(this.player.battle);
			if (this.player.damage > 0) {
				this.opposite.combo = this.opposite.battle;
			}
			else{
				this.opposite.discard.push(this.opposite.battle);
			}
			this.player.battle = this.opposite.battle = null;
		}

		this.status = GMSTATUS.Choice;
	}
  }
  


  var Game = new GameMaster();
  window.onload = function() {
  
	refresh()

	
	let discard_element = document.getElementById('discard');
	discard_element.onclick = function(){
		let dl_elem = document.getElementById('discardlist');

		while(dl_elem.lastChild){
			dl_elem.lastChild.remove();
		}
		Game.player.discard.forEach((elem, index) => {
			let card = 	create_card_element(elem);
			dl_elem.appendChild(card);
		});
		dl_elem.style.display = "flex";
	}
	discard_element = document.getElementById('oppositediscard');
	discard_element.onclick = function(){
		let dl_elem = document.getElementById('discardlist');

		while(dl_elem.lastChild){
			dl_elem.lastChild.remove();
		}
		Game.opposite.discard.forEach((elem, index) => {
			let card = 	create_card_element(elem);
			dl_elem.appendChild(card);
		});
		dl_elem.style.display = "flex";
	}
	
	discard_element = document.getElementById('discardlist');
	discard_element.onclick = function(){
		discard_element.style.display = "none";
	}
	let elem = document.getElementById('battleeffect');
	elem.onclick = function(){
		if (Game.status == GMSTATUS.GameEnd) {
			return;
		}
		elem.style.display = "none";
		Game.BattleEffect();
		refresh();
	}

};

function refresh()
{
	let hand_element = document.getElementById('hand');
	while(hand_element.lastChild){
		hand_element.lastChild.remove();
	}
	Game.player.hand.forEach((elem, index) => {
		let card = 	create_card_element(elem);
		card.classList.add("select");
		card.onclick = function() {
			Game.Choice(index);
			if (Game.status == GMSTATUS.BattleEffect)
			{
				let elem = document.getElementById('battleeffect');
				elem.style.display = "block";
				elem = document.getElementById('battlemessage_top');
				elem.textContent = Game.message_top;
				elem = document.getElementById('battlemessage_middle');
				elem.textContent = Game.message_middle;
				elem = document.getElementById('battlemessage_bottom');
				elem.textContent = Game.message_bottom;

			}
			if (Game.status == GMSTATUS.GameEnd)
			{
				let elem = document.getElementById('battleeffect');
				elem.style.display = "block";
				elem = document.getElementById('battlemessage_top');
				elem.textContent = Game.message_top;
				elem = document.getElementById('battlemessage_middle');
				elem.textContent = Game.message_middle;
				elem = document.getElementById('battlemessage_bottom');
				elem.textContent = Game.message_bottom;
			}
			refresh();
		}
		hand_element.appendChild(card);
	});

	hand_element = document.getElementById('oppositehand');
	while(hand_element.lastChild){
		hand_element.lastChild.remove();
	}
	Game.opposite.hand.forEach((elem, index) => {
		let card = 	create_card_element(elem);
		hand_element.appendChild(card);
	});	
	

	const pdecklength = Game.player.decknum + Game.player.draw.length;
	const odecklength = Game.opposite.decknum + Game.opposite.draw.length;
	
	document.getElementById('deck').innerHTML = '<span class="card">' + pdecklength + '</span>';
	document.getElementById('oppositedeck').innerHTML = '<span class="card">' + odecklength + '</span>';


	if (Game.player.battle)	{
		document.getElementById('battle').innerHTML = card_html(Game.player.battle,"");
		document.getElementById('oppositebattle').innerHTML = card_html(Game.opposite.battle,"");
	}
	else	{
		document.getElementById('battle').innerHTML = '<span class="card transparent" ></span>';
		document.getElementById('oppositebattle').innerHTML = '<span class="card transparent" ></span>';
	}

	if (Game.player.combo)	{
		document.getElementById('combo').innerHTML = card_html(Game.player.combo,"rotate90");
	}
	else	{
		document.getElementById('combo').innerHTML = '<span class="card transparent rotate90" ></span>';
	}
	if (Game.opposite.combo)	{
		document.getElementById('oppositecombo').innerHTML = card_html(Game.opposite.combo,"rotate90");
	}
	else	{
		document.getElementById('oppositecombo').innerHTML = '<span class="card transparent rotate90" ></span>';
	}	
}

function card_html(card,class_string)
{
return '<span class="card ' + class_string + '" ><font color="' + (card.red ? 'red' : 'black') + '">' + card.number + '</font></span>';
}
function create_card_element(card)
{
	let elem = document.createElement("span");
	elem.classList.add("card");
	if (card.red){
		elem.setAttribute("style","color:red");}
	else{
		elem.setAttribute("style","color:black");}
	elem.textContent = card.number;
	return elem;
}
	
  </script>
</head>
<body>
<div class="field">

<div id="oppositehand">
<span class="card">2</span>
<span class="card">3</span>
<span class="card">4</span>
<span class="card">5</span>
</div>

<div id="oppositedeck">
<span class="card">10</span>
</div>
<div id="oppositediscard">
<span class="card select">捨</span>
</div>

<div id="oppositebattle">
<span class="card" >1</span>
</div>
<div id="oppositecombo">
<span class="card rotate90" ></span>
</div>
<div id="combo">
<span class="card rotate90" ></span>
</div>
<div id="battle">
<span class="card" >1</span>
</div>

<div id="hand">
<span class="card select">2</span>
<span class="card select">3</span>
<span class="card select">4</span>
<span class="card select">5</span>
</div>

<div id="deck">
<span class="card">10</span>
</div>
<div id="discard">
<span class="card select">捨</span>
</div>

<div id="discardlist">
</div>
<div id="battleeffect">
	<div id="battlemessage_top"></div>
	<div id="battlemessage_middle"></div>
	<div id="battlemessage_bottom"></div>
</div>

</div>

</body>
</html>



